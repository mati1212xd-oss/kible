<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mapa toalet WUM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --font-primary: 'Roboto', Arial, sans-serif;
      --color-primary: #0056b3; 
      --color-primary-light: #e8f0fe; 
      --color-text: #212529; 
      --color-text-light: #555; 
      --color-bg: #f8f9fa; 
      --color-card-bg: #ffffff; 
      --color-border: #dee2e6; 
      --color-star: #ffc107; 
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --border-radius: 8px; 
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: var(--font-primary);
      text-align: center;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
    }

    img {
      max-width: 100%;
      height: auto;
    }

    .page-container {
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 0 1rem;
    }
    
    header {
      text-align: left;
      margin-bottom: 1rem;
    }
    
    header h2 {
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 0.5rem;
    }
    
    nav.tab-buttons {
      display: flex;
      flex-wrap: wrap;
      border-bottom: 2px solid var(--color-border);
    }
    
    .tab-link {
      background-color: transparent; 
      border: none;
      border-bottom: 3px solid transparent;
      outline: none;
      cursor: pointer;
      padding: 1rem 1.5rem; 
      transition: all 0.3s ease;
      font-size: 1.1rem; 
      font-weight: 500;
      color: var(--color-text-light);
      margin-right: 0.25rem;
      margin-bottom: -2px; 
    }
    
    .tab-link:hover:not(.active) {
      background-color: var(--color-primary-light);
      color: var(--color-primary);
    }
    
    .tab-link.active {
      color: var(--color-primary);
      font-weight: 700; 
      border-bottom-color: var(--color-primary);
    }
    
    .tab-content {
      display: none;
      padding: 1.5rem;
      border: none;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      background-color: var(--color-card-bg);
      text-align: center;
      box-shadow: var(--shadow-sm);
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tab-content p {
        font-size: 1rem;
        color: var(--color-text-light);
        margin-bottom: 1rem;
    }
    
    .tab-content h3 {
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }
    .tab-content hr {
        border: none;
        height: 1px;
        background-color: var(--color-border);
        margin: 1rem 0;
    }
    .content-box {
      text-align: left; 
      display: inline-flex; 
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-start;
      max-width: 100%;
    }
    .content-box p {
        margin-bottom: 0.25rem;
        font-size: 1.05rem;
        color: var(--color-text);
    }

    .map-container {
      position: relative;
      display: inline-block;
    }
    
    .map-container img {
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      display: block; 
    }
    
    .toilet {
      position: absolute;
      width: 18px;
      height: 18px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      transform: translate(-50%, -50%);
      border: 2px solid white;
      box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.3);
      transition: transform 0.2s ease;
      z-index: 2;
    }
    
    .toilet:hover {
      transform: translate(-50%, -50%) scale(1.25);
    }
    
    .toilet::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--color-primary);
      transform: translate(-50%, -50%);
      animation: pulse 2s infinite ease-out;
      z-index: -1;
    }

    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.7; }
      70% { transform: translate(-50%, -50%) scale(2.2); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
    }
    
    .tooltip {
      position: fixed;
      display: none; 
      flex-direction: column;
      gap: 0.75rem; 
      
      background: var(--color-card-bg);
      padding: 1rem;
      border: none;
      border-radius: var(--border-radius);
      
      white-space: normal;
      word-wrap: break-word; 
      max-width: 300px;      
      
      z-index: 1000; 
      font-size: 0.95rem; 
      box-shadow: var(--shadow-md); 
      text-align: left;
      line-height: 1.5;
    }
    
    #tooltip-info {
        color: var(--color-text);
        font-size: 1rem;
    }
    
    #tooltip-image {
        border-radius: calc(var(--border-radius) - 4px);
        /* --- POPRAWKA (Problem 1) --- */
        display: none; /* Domyślnie ukryty, zarządzany przez JS */
        max-height: 40vh; /* Ogranicza wysokość obrazka */
        object-fit: cover; /* Zapobiega zniekształceniom */
        width: 100%; /* Wypełnia kontener */
    }

    .tooltip hr {
        margin: 0; 
        border: none;
        height: 1px;
        background-color: var(--color-border);
    }

    .rating-display {
        margin-top: 0;
        text-align: center;
        color: var(--color-border);
    }
    
    .rating-display > span {
        display: inline-block;
        font-size: 1.5rem; 
        width: 1.1em;
        line-height: 1;
    }
    
    .rating-display > span.selected {
        color: var(--color-star);
    }
    
    /* --- Responsywność --- */
    @media (max-width: 600px) {
      html { font-size: 15px; }
      .page-container {
          margin-top: 0;
          padding: 0.5rem;
      }
      header {
          padding: 0.5rem;
      }
      header h2 {
          font-size: 1.8rem;
      }
      nav.tab-buttons {
          justify-content: flex-start; 
          flex-wrap: nowrap;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
      }
      .tab-link {
          padding: 0.75rem 1rem;
          font-size: 1rem;
          white-space: nowrap;
      }
      .tab-content {
          padding: 1rem;
      }
      .tooltip {
          max-width: calc(100vw - 2rem);
          /* --- POPRAWKA (Problem 1) --- */
          max-height: calc(100vh - 4rem); /* Ograniczenie wysokości dymka */
          overflow-y: auto; /* Dymek staje się przewijalny, jeśli treść jest za długa */
      }
    }
    
  </style>
</head>
<body>

<main class="page-container">

  <header>
    <h2>Mapa toalet WUM – Kampusy</h2>
  </header>

  <nav class="tab-buttons">
    <button class="tab-link active" data-tab="banacha">Kampus Banacha</button>
    <button class="tab-link" data-tab="wolska">Wolska</button>
    <button class="tab-link" data-tab="lindleya">Lindleya</button>
    <button class="tab-link" data-tab="litewska">Litewska</button>
  </nav>

  <div id="banacha" class="tab-content active">
    <p>Kliknij w pulsujące kółko, aby zobaczyć informację o toalecie.</p>
    <div class="map-container" id="map">
      <img src="mapa_wum.png" alt="Mapa WUM">
      <div class="toilet" data-toilet-id="toilet_farmacja" data-rating="2"
           style="top: 8.64%; left: 78.39%;" 
           data-info="Farmacja (nr 9): Słabe, średniowieczne toalety w piwnicach"></div>
      <div class="toilet" data-toilet-id="toilet_11" data-rating="4"
           style="top: 20.64%; left: 76.17%;" 
           data-info="UCS (nr 11): Dużo toalet 1-osobowych nowoczesnych. Na ostatnim piętrze duże toalety wieloosobowe"
           data-image="IMG_0483.jpg"></div>
      <div class="toilet" data-toilet-id="toilet_2" data-rating="0"
           style="top: 41.25%; left: 63.03%;" 
           data-info="CD (nr 2): Jedna na lewo od wejścia, druga na -1 przy windach. Słabe, dużo ludzi."></div>
      <div class="toilet" data-toilet-id="toilet_7a" data-rating="3"
           style="top: 25.80%; left: 39.17%;" 
           data-info="zaklad patomorfologii (nr 7): Dobra toaleta na 3 piętrze."></div>
      <div class="toilet" data-toilet-id="toilet_14" data-rating="4"
           style="top: 24.89%; left: 26.03%;" 
           data-info="CSM (nr 14): Duże toalety w szatniach w podziemiach, brak ludzi i brak zasięgu. Na 2 piętrze też spoko"
           data-image="IMG_0788.jpg"></div>
      <div class="toilet" data-toilet-id="toilet_13" data-rating="5"
           style="top: 42.86%; left: 43.32%;" 
           data-info="CSR (nr 13): Fajne toalety, dużo ich na każdym piętrze, mało ludzi, ale otwarte"></div>
    </div>
  </div>

  <div id="wolska" class="tab-content">
    <h3>Szpital Wolska</h3>
    <div class="content-box">
        <p>Bardzo fajne toalety na 1 piętrze w budynku gdzie są sale seminaryjne, mało ludzi.</p>
        <p>Fajna toaleta na prawo za szatnią w budynku szpitala</p>
        <hr>
        <div class="rating-display" style="text-align: left;"> <span class="selected">★</span><span class="selected">★</span><span class="selected">★</span><span class="selected">★</span><span class="selected">★</span>
        </div>
    </div>
  </div>

  <div id="lindleya" class="tab-content">
    <h3>Kampus Lindleya</h3>
    <div class="map-container">
      <img src="mapa-lindleya.png" alt="Mapa Kampusu Lindleya">
      <div class="toilet" data-toilet-id="toilet_lindleya_1" data-rating="3"
           style="top: 36.45%; left: 34.94%;" 
           data-info="(NR 10) Totalny PRL, spłukiwanie sznurkiem zwisającym z góry. Jedna w szatni studenckiej w podziemiach, druga na wprost od recepcji od wejścia. Jednoosobowe, ta koło recepcji lepsza."
           data-image="IMG_0702.jpg"></div>
    </div>
  </div>

  <div id="litewska" class="tab-content">
    <h3>Kampus Litewska</h3>
    <div class="content-box">
      <p>Dobre, nowoczesne toalety na każdym piętrze, dosyć mało ludzi.</p>
      <hr>
      <div class="rating-display" style="text-align: left;"> 
          <span class="selected">★</span>
          <span class="selected">★</span>
          <span class="selected">★</span>
          <span class="selected">★</span>
          <span>★</span>
      </div>
    </div>
  </div>

</main> 

<div class="tooltip" id="tooltip">
    <div id="tooltip-info"></div>
    <img id="tooltip-image" src="" alt="Zdjęcie toalety">
    <hr>
    <div style="font-weight: bold; text-align: center;">Ocena użytkownika:</div>
    <div class="rating-display" id="rating-display"></div>
</div>

<script>
  // --- ZMIENIONY SKRYPT (Problem 2) ---
  const toilets = document.querySelectorAll('.toilet');
  const tooltip = document.getElementById('tooltip');
  const tooltipInfo = document.getElementById('tooltip-info');
  const tooltipImage = document.getElementById('tooltip-image');
  const ratingDisplay = document.getElementById('rating-display');

  // --- FUNKCJA DO POZYCJONOWANIA DYMKA ---
  function positionTooltip(clickX, clickY) {
    // Ta funkcja musi być wywołana PO tym, jak tooltip stał się widoczny,
    // aby offsetWidth i offsetHeight nie były równe 0.
    const tooltipWidth = tooltip.offsetWidth;
    const tooltipHeight = tooltip.offsetHeight;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    let newLeft = clickX + 15; 
    if (newLeft + tooltipWidth + 10 > windowWidth) {
      newLeft = clickX - tooltipWidth - 15; 
      if (newLeft < 10) {
          newLeft = 10;
      }
    }
    
    let newTop = clickY + 15;
    if (newTop + tooltipHeight + 10 > windowHeight) {
      newTop = clickY - tooltipHeight - 15;
      if (newTop < 10) {
          newTop = 10;
      }
    }

    tooltip.style.top = newTop + 'px'; 
    tooltip.style.left = newLeft + 'px';
  }

  // --- FUNKCJA DO CHOWANIA DYMKA ---
  const hideTooltip = () => {
    tooltip.style.display = 'none';
    tooltipImage.style.display = 'none'; // Ukryj element obrazka
    tooltipImage.src = ''; // Wyczyść źródło, aby zatrzymać ładowanie
    tooltipImage.onload = null; // Usuń listener, aby uniknąć błędów
  };

  // --- OBSŁUGA KLIKNIĘCIA W TOALETĘ (NOWA LOGIKA) ---
  toilets.forEach(t => {
    t.addEventListener('click', (e) => {
      e.stopPropagation(); 
      
      const info = t.getAttribute('data-info');
      const rating = parseInt(t.getAttribute('data-rating')) || 0; 
      const imageUrl = t.getAttribute('data-image'); 
      const clickX = e.clientX;
      const clickY = e.clientY;
      
      // 1. Zaktualizuj tekst i gwiazdki (to jest szybkie)
      tooltipInfo.textContent = info;
      
      let starsHtml = '';
      const totalStars = 5;
      for (let i = 1; i <= totalStars; i++) {
        const starClass = i <= rating ? 'selected' : '';
        starsHtml += `<span class="${starClass}">★</span>`;
      }
      ratingDisplay.innerHTML = starsHtml;

      // 2. Obsługa obrazka (to jest wolne)
      if (imageUrl) {
        // Ustaw funkcję, która ma się wykonać PO załadowaniu obrazka
        tooltipImage.onload = () => {
          tooltipImage.style.display = 'block'; // Pokaż element obrazka
          tooltip.style.display = 'flex'; // Pokaż dymek
          positionTooltip(clickX, clickY); // Oblicz pozycję
          tooltipImage.onload = null; // Wyczyść listener
        };
        
        // Ustaw źródło obrazka (co rozpoczyna ładowanie)
        tooltipImage.src = imageUrl;

        // Obsługa obrazków z pamięci podręcznej (cache)
        // Jeśli obrazek jest 'complete', ręcznie wywołaj 'onload'
        if (tooltipImage.complete) {
          tooltipImage.onload();
        }
        
      } else {
        // Jeśli nie ma obrazka, po prostu pokaż dymek i ustaw pozycję
        tooltipImage.style.display = 'none';
        tooltipImage.src = '';
        tooltipImage.onload = null;
        
        tooltip.style.display = 'flex'; // Pokaż dymek
        positionTooltip(clickX, clickY); // Oblicz pozycję
      }
    });
  });

  // Zamykanie dymka (teraz używa funkcji hideTooltip)
  document.addEventListener('click', (e) => {
    if (!tooltip.contains(e.target)) {
      hideTooltip();
    }
  });

  // --- SKRYPT DLA ZAKŁADEK (NOWA LOGIKA) ---
  const tabButtons = document.querySelectorAll('.tab-link');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      const tabId = button.getAttribute('data-tab');
      document.getElementById(tabId).classList.add('active');
      button.classList.add('active');
      
      // Ukryj dymek przy zmianie zakładki
      hideTooltip();
    });
  });
</script>

</body>
</html>
